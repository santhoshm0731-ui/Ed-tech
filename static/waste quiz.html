{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
  <h2 class="text-center mb-4">Level 2: Waste Segregation</h2>

  <!-- ðŸŽ¥ Video Section -->
  <div class="text-center mb-4">
    <h4>Watch this video to unlock the quiz</h4>
    <video id="wasteVideo" width="640" height="360" controls>
      <source src="{% static 'videos/waste_wizard.mp4' %}" type="video/mp4">
      Your browser does not support the video tag.
    </video>
    <p id="video-status" class="text-muted mt-2">
      â–¶ Watch the full video to unlock the quiz.
    </p>
  </div>

  <!-- ðŸ§© Quiz Section (hidden initially) -->
  <div id="quizSection" style="display:none;" class="quiz-container">
    <h3>Waste Segregation Quiz</h3>
    <div id="question" class="question mt-3"></div>
    <ul id="options" class="options list-unstyled"></ul>
    <div id="feedback" class="mt-2 fw-bold"></div>
    <div id="explanation" class="text-muted mt-2"></div>

    <div class="mt-3 text-center">
      <button id="next-btn" class="btn btn-primary" style="display:none;">Next Question</button>
      <button id="restart-btn" class="btn btn-secondary" style="display:none;">Restart</button>
    </div>

    <div id="score-container" class="text-center mt-4 fw-bold"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const video = document.getElementById("wasteVideo");
  const quizSection = document.getElementById("quizSection");
  const videoStatus = document.getElementById("video-status");

  // Log video state to console (helps debug)
  video.addEventListener("play", () => console.log("Video started playing"));
  video.addEventListener("ended", () => {
    console.log("âœ… Video ended event triggered");
    quizSection.style.display = "block";
    videoStatus.textContent = "âœ… Video completed! You can now take the quiz.";
    videoStatus.classList.remove("text-muted");
    videoStatus.classList.add("text-success");
    loadQuestion();
  });

  const quizData = [
    {
      question: "Which bin should banana peels be disposed in?",
      options: ["Organic Waste", "Recyclable Waste", "Hazardous Waste", "E-waste"],
      correct: 0,
      explanation: "Banana peels are biodegradable and belong in the organic waste bin."
    },
    {
      question: "Where should plastic bottles be placed?",
      options: ["Organic Waste", "Recyclable Waste", "Hazardous Waste", "Landfill"],
      correct: 1,
      explanation: "Plastic bottles can be recycled and should go in the recyclable bin."
    }
  ];

  let current = 0;
  let score = 0;

  const qEl = document.getElementById("question");
  const optEl = document.getElementById("options");
  const feedbackEl = document.getElementById("feedback");
  const expEl = document.getElementById("explanation");
  const nextBtn = document.getElementById("next-btn");
  const restartBtn = document.getElementById("restart-btn");
  const scoreEl = document.getElementById("score-container");

  function loadQuestion() {
    const q = quizData[current];
    qEl.textContent = `Q${current + 1}. ${q.question}`;
    optEl.innerHTML = "";
    feedbackEl.textContent = "";
    expEl.textContent = "";
    q.options.forEach((opt, i) => {
      const li = document.createElement("li");
      li.textContent = opt;
      li.classList.add("border", "p-2", "rounded", "mt-2");
      li.style.cursor = "pointer";
      li.onclick = () => selectAnswer(i);
      optEl.appendChild(li);
    });
  }

  function selectAnswer(selected) {
    const q = quizData[current];
    const listItems = optEl.querySelectorAll("li");
    listItems.forEach((li, idx) => {
      li.onclick = null;
      if (idx === q.correct) li.style.backgroundColor = "#c8e6c9";
      else if (idx === selected) li.style.backgroundColor = "#ffcdd2";
    });
    if (selected === q.correct) {
      feedbackEl.textContent = "âœ… Correct!";
      score++;
    } else {
      feedbackEl.textContent = "âŒ Wrong!";
    }
    expEl.textContent = q.explanation;
    nextBtn.style.display = "inline-block";
  }

  nextBtn.onclick = () => {
    current++;
    if (current < quizData.length) {
      nextBtn.style.display = "none";
      loadQuestion();
    } else {
      showResults();
    }
  };

  restartBtn.onclick = () => {
    current = 0;
    score = 0;
    restartBtn.style.display = "none";
    nextBtn.style.display = "none";
    scoreEl.textContent = "";
    loadQuestion();
  };

  function showResults() {
    qEl.textContent = "Quiz Completed!";
    optEl.innerHTML = "";
    feedbackEl.textContent = "";
    expEl.textContent = "";
    scoreEl.textContent = `You scored ${score} / ${quizData.length}`;
    nextBtn.style.display = "none";
    restartBtn.style.display = "inline-block";

    // Award points if full score
    if (score === quizData.length) {
      fetch("{% url 'complete_level' 2 %}", {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
      });
    }
  }
});
</script>
{% endblock %}
